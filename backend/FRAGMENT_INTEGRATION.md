# Telegram Gifts Tracker - Backend

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ Telegram-–ø–æ–¥–∞—Ä–∫–∞—Ö —Å Fragment.com

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥** Fragment.com –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- **–î–≤–æ–π–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**: GraphQL API + HTML –ø–∞—Ä—Å–∏–Ω–≥ (fallback)
- **–£–º–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** —Å –æ—á–µ—Ä–µ–¥—å—é, retry –ª–æ–≥–∏–∫–æ–π –∏ MD5 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- **–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω** –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ SQLite
- **WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –æ –Ω–æ–≤—ã—Ö –ø–æ–¥–∞—Ä–∫–∞—Ö –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ü–µ–Ω
- **REST API** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

## üì¶ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
FragmentParser (GraphQL/HTML)
       ‚Üì
GiftSynchronizer (cron scheduler)
       ‚Üì
  DatabaseService (SQLite)
       ‚Üì
  ImageLoader (queue-based)
       ‚Üì
   WebSocket broadcast
```

## üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
cd backend
npm install
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–§–∞–π–ª `.env`:

```env
PORT=3000
SYNC_INTERVAL_SECONDS=30  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
MAX_CONCURRENT_DOWNLOADS=3 # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
DB_PATH=./database/gifts.db
ASSETS_PATH=../assets/gifts
```

## üèÉ –ó–∞–ø—É—Å–∫

```bash
# Development
npm run dev

# Production
npm start
```

## üì° API Endpoints

### Gifts
- `GET /api/gifts` - –í—Å–µ –ø–æ–¥–∞—Ä–∫–∏
- `GET /api/gifts/:id` - –ü–æ–¥–∞—Ä–æ–∫ –ø–æ ID
- `GET /api/gifts/:id/history` - –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω

### Sync
- `GET /api/sync/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `POST /api/sync/now` - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é

### Images
- `GET /api/images/stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### System
- `GET /api/health` - Health check

## üîå WebSocket Events

### –û—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É:

```javascript
// –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
{
  type: 'initial',
  data: [...gifts]
}

// –ù–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫
{
  type: 'new_gift',
  data: { gift }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã
{
  type: 'price_change',
  data: {
    gift: { id, name, oldPrice, newPrice },
    change: 'increase' | 'decrease'
  }
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
{
  type: 'sync_stats',
  data: { totalGifts, lastSync, ... }
}
```

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `gifts`
- `id` - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞
- `slug` - URL-—Å–ª–∞–≥
- `price` - –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
- `currency` - –í–∞–ª—é—Ç–∞ (TON)
- `collection` - –ö–æ–ª–ª–µ–∫—Ü–∏—è (plushpepe, heartlocket, etc.)
- `image_path` - –ü—É—Ç—å –∫ PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
- `source` - –ò—Å—Ç–æ—á–Ω–∏–∫ (fragment)
- `last_updated` - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞ `price_history`
- `id` - ID –∑–∞–ø–∏—Å–∏
- `gift_id` - ID –ø–æ–¥–∞—Ä–∫–∞
- `price` - –¶–µ–Ω–∞
- `timestamp` - –í—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

### FragmentParser
–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å Fragment.com:
1. –ü–æ–ø—ã—Ç–∫–∞ GraphQL API
2. Fallback –Ω–∞ HTML –ø–∞—Ä—Å–∏–Ω–≥
3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 60 —Å–µ–∫—É–Ω–¥

### GiftSynchronizer
–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é:
- Cron –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω
- WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### ImageLoader
–£–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
- –û—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- Retry –ª–æ–≥–∏–∫–∞ (3 –ø–æ–ø—ã—Ç–∫–∏)
- MD5 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ (3)

### DatabaseService
SQLite —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤
- –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```javascript
{
  totalGifts: 156,
  newGiftsAdded: 5,
  priceChanges: 12,
  lastSync: '2024-01-15T12:30:00Z',
  nextSync: '2024-01-15T12:30:30Z',
  isRunning: true
}
```

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
```javascript
{
  totalDownloads: 156,
  successfulDownloads: 150,
  failedDownloads: 6,
  queueSize: 3,
  activeDownloads: 2
}
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
- ‚úÖ –£—Å–ø–µ—à–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- üÜï –ù–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏
- üí∞ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω
- üñºÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- ‚ùå –û—à–∏–±–∫–∏

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–¥–∞—Ä–∫–∏
```javascript
const response = await fetch('http://localhost:3000/api/gifts');
const { data } = await response.json();
console.log(data); // Array of gifts
```

### WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```javascript
const ws = new WebSocket('ws://localhost:3000');
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  if (message.type === 'price_change') {
    console.log('Price changed:', message.data);
  }
};
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é
```bash
curl -X POST http://localhost:3000/api/sync/now
```

## üö¶ Production —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**: 30-60 —Å–µ–∫—É–Ω–¥ (–Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π—Ç–µ Fragment.com)
2. **Rate limiting**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ exponential backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
4. **Backup**: –†–µ–≥—É–ª—è—Ä–Ω–æ –±—ç–∫–∞–ø—å—Ç–µ `database/gifts.db`
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Winston/Pino –¥–ª—è production –ª–æ–≥–æ–≤
